<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <!-- PDF.js ãƒ©ã‚¤ãƒ–ãƒ©ãƒª (â˜…ä¿®æ­£: URLã‚’æ­£ã—ã„å½¢å¼ã«ã—ã¾ã—ãŸ) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>

  <title>è«‹æ±‚æ›¸OCRã‚¢ãƒ—ãƒª(ãƒ•ã‚©ãƒ«ãƒ€ä¿å­˜ç‰ˆ)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <style>
    /* --- åŸºæœ¬ã‚¹ã‚¿ã‚¤ãƒ« --- */
    body { font-family: sans-serif; background-color: #f4f7f6; color: #333; margin: 0; }
    
    .app-header {
      background: linear-gradient(135deg, #0a9396, #005f73);
      color: white; padding: 20px 40px; text-align: center;
    }
    .app-header h1 { margin: 0; font-size: 1.8em; }
    
    .container {
      max-width: 95%; margin: 20px auto; padding: 24px;
      background-color: #ffffff; border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
    }
    
    /* --- æ“ä½œã‚¨ãƒªã‚¢ --- */
    #operation-area {
      display: flex; gap: 20px; align-items: flex-start;
      margin-bottom: 20px;
    }
    
    /* --- ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚¨ãƒªã‚¢ --- */
    #upload-section {
      flex: 1; padding: 20px;
      border: 2px dashed #0a9396; border-radius: 8px;
      background-color: #e9f5f5; text-align: center;
    }
    #file-input { display: none; }
    .btn-upload {
      display: inline-block; padding: 10px 20px;
      background-color: #0a9396; color: white; border-radius: 6px;
      cursor: pointer; font-weight: bold;
    }

    /* --- ãƒ•ã‚¡ã‚¤ãƒ«ãƒªã‚¹ãƒˆã‚¨ãƒªã‚¢ --- */
    #queue-section {
      flex: 2; border: 1px solid #ddd; border-radius: 8px;
      padding: 10px; background-color: #fafafa;
      min-height: 200px;
    }
    .queue-controls {
      margin-bottom: 10px; display: flex; gap: 10px;
    }
    .btn-small {
      padding: 6px 12px; font-size: 14px; cursor: pointer;
      border: 1px solid #ccc; background-color: white; border-radius: 4px;
    }
    .btn-combine { background-color: #e9ecef; color: #005f73; border-color: #005f73; }
    .btn-run {
      background-color: #d62828; color: white; border: none; font-weight: bold;
      margin-left: auto; /* å³å¯„ã› */
    }

    /* ãƒªã‚¹ãƒˆã‚¢ã‚¤ãƒ†ãƒ  */
    .queue-list { list-style: none; padding: 0; margin: 0; }
    .queue-item {
      background: white; border: 1px solid #ddd; margin-bottom: 8px;
      padding: 10px; border-radius: 6px; display: flex; align-items: center;
    }
    .queue-item.combined {
      border-left: 5px solid #0a9396; background-color: #f0fdfd;
    }
    .queue-checkbox { margin-right: 10px; transform: scale(1.2); }
    .queue-info { flex-grow: 1; }
    .queue-title { font-weight: bold; font-size: 14px; }
    .queue-sub { font-size: 12px; color: #666; }
    
    /* --- çµæœç”»é¢ --- */
    #loading-container, #result-container { display: none; }
    
    .spinner {
      border: 4px solid #f3f3f3; border-top: 4px solid #0a9396;
      border-radius: 50%; width: 40px; height: 40px;
      animation: spin 1s linear infinite; margin: 20px auto;
    }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    #tab-container { margin-top: 20px; border-bottom: 2px solid #0a9396; }
    .tab-item {
      padding: 10px 15px; cursor: pointer; background: #eee;
      border: 1px solid #ddd; border-bottom: none; margin-right: 4px;
      border-radius: 5px 5px 0 0; display: inline-block;
    }
    .tab-item.active { background: #0a9396; color: white; font-weight: bold; }

    .preview-container { display: flex; gap: 20px; margin-top: 20px; }
    .left-col { flex: 1; border: 1px solid #ccc; padding: 10px; text-align: center; background: #eee; }
    .right-col { flex: 1; border: 1px solid #ccc; padding: 10px; height: 80vh; overflow-y: auto; }
    img#preview-img { max-width: 100%; height: auto; }
    
    .form-row { margin-bottom: 10px; }
    .form-row label { display: block; font-weight: bold; font-size: 0.9em; }
    .form-row input { width: 100%; padding: 6px; box-sizing: border-box; }
    
    table.child-table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    table.child-table th, table.child-table td { border: 1px solid #ccc; padding: 6px; font-size: 0.9em; }
    table.child-table th { background: #eee; }

  </style>
</head>
<body>
  
  <header class="app-header">
    <h1>è«‹æ±‚æ›¸ OCR ã‚¢ãƒ—ãƒª (ãƒ•ã‚©ãƒ«ãƒ€ä¿å­˜ç‰ˆ)</h1>
  </header>

  <div class="container">

    <!-- Step 1: ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠ -->
    <div id="operation-area">
      <div id="upload-section">
        <label for="file-input" class="btn-upload">
          + ãƒ•ã‚¡ã‚¤ãƒ«ã‚’è¿½åŠ 
        </label>
        <input type="file" id="file-input" accept="image/jpeg, image/png, application/pdf" multiple>
        <p style="font-size:12px; margin-top:10px;">ç”»åƒã¾ãŸã¯PDFã‚’é¸æŠ</p>
      </div>

      <div id="queue-section">
        <div class="queue-controls">
          <button class="btn-small btn-combine" id="btn-combine">ğŸ”— é¸æŠã‚’çµåˆ</button>
          <button class="btn-small" id="btn-split">âš¡ çµåˆè§£é™¤</button>
          <button class="btn-small" id="btn-delete">ğŸ—‘ï¸ å‰Šé™¤</button>
          <button class="btn-small btn-run" id="btn-run-ocr">â–¶ OCRè§£æé–‹å§‹</button>
        </div>
        <ul id="queue-list" class="queue-list">
          <li style="color:#888; text-align:center; padding:20px;">ãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚ã‚Šã¾ã›ã‚“</li>
        </ul>
      </div>
    </div>

    <!-- Step 2: ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚° -->
    <div id="loading-container" style="text-align:center;">
      <div class="spinner"></div>
      <p id="loading-msg">å‡¦ç†ä¸­...</p>
    </div>

    <!-- Step 3: çµæœç¢ºèª -->
    <div id="result-container">
      <div id="tab-container"></div>
      
      <div class="preview-container">
        <div class="left-col">
          <!-- ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ (1æšç›®ã®ã¿è¡¨ç¤º) -->
          <p style="font-size:12px; color:#666;">â€»ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã¯1æšç›®ã®ã¿è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚<br>å…¨ãƒ•ã‚¡ã‚¤ãƒ«ã¯ä¿å­˜å…ˆã®ãƒ•ã‚©ãƒ«ãƒ€ã§ç¢ºèªã§ãã¾ã™ã€‚</p>
          <img id="preview-img" src="" style="display:none;">
          <canvas id="pdf-canvas" style="display:none; width:100%;"></canvas>
        </div>
        <div class="right-col">
           <h4>è¦ªæƒ…å ±</h4>
           <div id="parent-form"></div>
           <hr>
           <h4>æ˜ç´°è¡Œ</h4>
           <button id="add-row-btn" class="btn-small">+ è¡Œè¿½åŠ </button>
           <div id="child-table-area"></div>
        </div>
      </div>
      
      <div style="text-align:right; margin-top:20px;">
        <button id="save-all-btn" class="btn-upload">ã™ã¹ã¦ä¿å­˜</button>
      </div>
    </div>

  </div>
  
  <div id="toast" style="position:fixed; top:20px; left:50%; transform:translate(-50%); background:#333; color:white; padding:10px 20px; border-radius:5px; display:none;"></div>

  <!-- ã‚¹ã‚¯ãƒªãƒ—ãƒˆ -->
  <script>
    let queueItems = []; 
    let queueIdCounter = 1;
    let ocrItems = { parent: [], child: [] };
    let results = []; 
    let currentResultIndex = 0;

    // â˜…ä¿®æ­£: URLã‹ã‚‰ä½™è¨ˆãª []() ã‚’å‰Šé™¤ã—ã¾ã—ãŸ
    const pdfjsWorkerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    pdfjsLib.GlobalWorkerOptions.workerSrc = pdfjsWorkerSrc;

    window.addEventListener('load', () => {
      loadInitialData();
      document.getElementById('file-input').addEventListener('change', handleFileSelect);
      document.getElementById('btn-combine').addEventListener('click', combineSelected);
      document.getElementById('btn-split').addEventListener('click', splitSelected);
      document.getElementById('btn-delete').addEventListener('click', deleteSelected);
      document.getElementById('btn-run-ocr').addEventListener('click', startOcrProcess);
      document.getElementById('save-all-btn').addEventListener('click', saveAll);
      document.getElementById('add-row-btn').addEventListener('click', addChildRow);
    });
    
    function loadInitialData() {
      google.script.run
        .withSuccessHandler(data => { ocrItems = { parent: data.parentItems, child: data.childItems }; })
        .getInitialData();
    }

    // --- ãƒ•ã‚¡ã‚¤ãƒ«ãƒªã‚¹ãƒˆæ“ä½œ ---
    function handleFileSelect(e) {
      const files = Array.from(e.target.files);
      if(files.length === 0) return;
      files.forEach(f => {
        queueItems.push({ id: queueIdCounter++, files: [f] });
      });
      document.getElementById('file-input').value = "";
      renderQueue();
    }

    function renderQueue() {
      const listEl = document.getElementById('queue-list');
      listEl.innerHTML = "";
      if (queueItems.length === 0) {
        listEl.innerHTML = '<li style="color:#888; text-align:center; padding:20px;">ãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚ã‚Šã¾ã›ã‚“</li>';
        return;
      }
      queueItems.forEach(item => {
        const li = document.createElement('li');
        li.className = item.files.length > 1 ? 'queue-item combined' : 'queue-item';
        let title = item.files[0].name;
        let sub = "";
        if (item.files.length > 1) {
          title = `[çµåˆ] ${item.files.length}ãƒ•ã‚¡ã‚¤ãƒ« (${item.files[0].name} ä»–)`;
          sub = item.files.map(f => f.name).join(', ');
        }
        li.innerHTML = `
          <input type="checkbox" class="queue-checkbox" value="${item.id}">
          <div class="queue-info">
            <div class="queue-title">${title}</div>
            <div class="queue-sub">${sub}</div>
          </div>
        `;
        listEl.appendChild(li);
      });
    }

    function combineSelected() {
      const checkboxes = document.querySelectorAll('.queue-checkbox:checked');
      if (checkboxes.length < 2) return showToast("çµåˆã™ã‚‹ã«ã¯2ã¤ä»¥ä¸Šé¸æŠã—ã¦ãã ã•ã„");
      const selectedIds = Array.from(checkboxes).map(cb => parseInt(cb.value));
      const selectedItems = queueItems.filter(item => selectedIds.includes(item.id));
      const unselectedItems = queueItems.filter(item => !selectedIds.includes(item.id));
      let mergedFiles = [];
      selectedItems.forEach(item => mergedFiles = mergedFiles.concat(item.files));
      const newItem = { id: queueIdCounter++, files: mergedFiles };
      queueItems = [...unselectedItems, newItem];
      renderQueue();
    }

    function splitSelected() {
      const checkboxes = document.querySelectorAll('.queue-checkbox:checked');
      if (checkboxes.length === 0) return;
      const selectedIds = Array.from(checkboxes).map(cb => parseInt(cb.value));
      let newQueue = [];
      queueItems.forEach(item => {
        if (selectedIds.includes(item.id)) {
          item.files.forEach(f => newQueue.push({ id: queueIdCounter++, files: [f] }));
        } else {
          newQueue.push(item);
        }
      });
      queueItems = newQueue;
      renderQueue();
    }

    function deleteSelected() {
      const checkboxes = document.querySelectorAll('.queue-checkbox:checked');
      if (checkboxes.length === 0) return;
      const selectedIds = Array.from(checkboxes).map(cb => parseInt(cb.value));
      queueItems = queueItems.filter(item => !selectedIds.includes(item.id));
      renderQueue();
    }

    // --- OCRå®Ÿè¡Œ ---
    async function startOcrProcess() {
      if (queueItems.length === 0) return showToast("ãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚ã‚Šã¾ã›ã‚“");
      document.getElementById('operation-area').style.display = 'none';
      document.getElementById('loading-container').style.display = 'block';
      results = [];

      for (let i = 0; i < queueItems.length; i++) {
        const item = queueItems[i];
        updateLoadingMsg(`å‡¦ç†ä¸­: ${i+1} / ${queueItems.length} ä»¶ç›®<br>(${item.files[0].name}...)`);
        
        try {
          const imagesData = await Promise.all(item.files.map(file => readFileAsBase64(file)));
          const groupName = item.files.length > 1 ? `[çµåˆ] ${item.files[0].name}` : item.files[0].name;
          
          const result = await runOcrGas(imagesData, groupName);
          result.allImagesData = imagesData;
          results.push(result);

        } catch (e) {
          console.error(e);
          results.push({ error: e.message, fileName: item.files[0].name });
        }
      }
      showResultScreen();
    }

    function readFileAsBase64(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = (e) => {
          const [meta, base64] = e.target.result.split(',');
          const mime = meta.split(':')[1].split(';')[0];
          resolve({ mimeType: mime, base64: base64, fileName: file.name });
        };
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });
    }

    function runOcrGas(imagesData, groupName) {
      return new Promise((resolve, reject) => {
        google.script.run
          .withSuccessHandler(resolve)
          .withFailureHandler(reject)
          .runOcr(imagesData, groupName);
      });
    }

    function updateLoadingMsg(html) {
      document.getElementById('loading-msg').innerHTML = html;
    }

    // --- çµæœè¡¨ç¤º ---
    function showResultScreen() {
      document.getElementById('loading-container').style.display = 'none';
      document.getElementById('result-container').style.display = 'block';
      
      const tabContainer = document.getElementById('tab-container');
      tabContainer.innerHTML = "";
      
      results.forEach((res, idx) => {
        const btn = document.createElement('div');
        btn.className = 'tab-item';
        btn.textContent = res.fileName || `Item ${idx+1}`;
        if(res.error) btn.style.color = 'red';
        btn.onclick = () => selectTab(idx);
        tabContainer.appendChild(btn);
      });

      if(results.length > 0) selectTab(0);
    }

    function selectTab(index) {
      currentResultIndex = index;
      document.querySelectorAll('.tab-item').forEach((el, i) => el.classList.toggle('active', i === index));
      const res = results[index];
      
      const formDiv = document.getElementById('parent-form');
      const tableDiv = document.getElementById('child-table-area');
      const imgPreview = document.getElementById('preview-img');
      const pdfCanvas = document.getElementById('pdf-canvas');

      if (res.error) {
        formDiv.innerHTML = `<p style="color:red">ã‚¨ãƒ©ãƒ¼: ${res.error}</p>`;
        tableDiv.innerHTML = "";
        imgPreview.style.display = 'none';
        pdfCanvas.style.display = 'none';
        return;
      }

      if (res.mimeType === 'application/pdf') {
        imgPreview.style.display = 'none';
        pdfCanvas.style.display = 'block';
        renderPdf(res.base64Data);
      } else {
        pdfCanvas.style.display = 'none';
        imgPreview.style.display = 'block';
        imgPreview.src = `data:${res.mimeType};base64,${res.base64Data}`;
      }

      let html = "";
      ocrItems.parent.forEach(key => {
        const val = res.extractedData.parent[key] || "";
        html += `<div class="form-row"><label>${key}</label>
                 <input type="text" data-key="${key}" value="${val}" onchange="updateParent(this)"></div>`;
      });
      formDiv.innerHTML = html;
      renderChildTable();
    }

    function renderChildTable() {
      const res = results[currentResultIndex];
      const tableDiv = document.getElementById('child-table-area');
      const data = res.extractedData.child;
      const keys = ocrItems.child;

      let html = '<table class="child-table"><thead><tr>';
      keys.forEach(k => html += `<th>${k}</th>`);
      html += '<th>å‰Šé™¤</th></tr></thead><tbody>';

      data.forEach((row, rIdx) => {
        html += `<tr>`;
        keys.forEach(k => {
          html += `<td contenteditable="true" onblur="updateChild(${rIdx}, '${k}', this)">${row[k] || ""}</td>`;
        });
        html += `<td><button onclick="deleteChildRow(${rIdx})" style="color:red;">Ã—</button></td></tr>`;
      });
      html += '</tbody></table>';
      tableDiv.innerHTML = html;
    }
    
    window.updateParent = (input) => { results[currentResultIndex].extractedData.parent[input.dataset.key] = input.value; };
    window.updateChild = (rIdx, key, cell) => { results[currentResultIndex].extractedData.child[rIdx][key] = cell.innerText; };
    window.deleteChildRow = (rIdx) => {
       results[currentResultIndex].extractedData.child.splice(rIdx, 1);
       renderChildTable();
    };
    function addChildRow() {
       results[currentResultIndex].extractedData.child.push({});
       renderChildTable();
    }

    function renderPdf(base64) {
       const pdfData = atob(base64);
       pdfjsLib.getDocument({data: pdfData}).promise.then(pdf => {
         pdf.getPage(1).then(page => {
           const canvas = document.getElementById('pdf-canvas');
           const ctx = canvas.getContext('2d');
           const viewport = page.getViewport({scale: 1.0});
           canvas.height = viewport.height;
           canvas.width = viewport.width;
           page.render({canvasContext: ctx, viewport: viewport});
         });
       });
    }

    // --- ä¿å­˜å‡¦ç† ---
    function saveAll() {
      const validResults = results.filter(r => !r.error);
      if (validResults.length === 0) return showToast("ä¿å­˜ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“");
      
      const btn = document.getElementById('save-all-btn');
      btn.textContent = "ä¿å­˜ä¸­...";
      btn.disabled = true;

      google.script.run
        .withSuccessHandler(res => {
           showToast(res.message || "å®Œäº†");
           setTimeout(() => resetApp(), 1500); // â˜…ãƒªãƒ­ãƒ¼ãƒ‰ã§ã¯ãªããƒªã‚»ãƒƒãƒˆã‚’å‘¼ã¶
        })
        .withFailureHandler(err => {
           showToast("ä¿å­˜å¤±æ•—: " + err.message);
           btn.disabled = false;
        })
        .saveAllData(validResults);
    }
    
    // â˜… ã‚¢ãƒ—ãƒªã®çŠ¶æ…‹ã‚’åˆæœŸåŒ–ã—ã¦æœ€åˆã®ç”»é¢ã«æˆ»ã™é–¢æ•°
    function resetApp() {
      // å¤‰æ•°ãƒªã‚»ãƒƒãƒˆ
      queueItems = [];
      results = [];
      currentResultIndex = 0;
      
      // ç”»é¢åˆ‡ã‚Šæ›¿ãˆ
      document.getElementById('operation-area').style.display = 'flex';
      document.getElementById('loading-container').style.display = 'none';
      document.getElementById('result-container').style.display = 'none';
      
      // å…¥åŠ›ãƒ»ãƒªã‚¹ãƒˆã‚¯ãƒªã‚¢
      document.getElementById('file-input').value = "";
      renderQueue();
      
      // ãƒ•ã‚©ãƒ¼ãƒ ã‚¯ãƒªã‚¢
      document.getElementById('parent-form').innerHTML = "";
      document.getElementById('child-table-area').innerHTML = "";
      document.getElementById('preview-img').src = "";
      
      // ãƒœã‚¿ãƒ³å¾©å¸°
      const btn = document.getElementById('save-all-btn');
      btn.disabled = false;
      btn.textContent = "ã™ã¹ã¦ä¿å­˜";
      
      // å¿µã®ãŸã‚é …ç›®å®šç¾©ã‚’å†ãƒ­ãƒ¼ãƒ‰
      loadInitialData();
    }

    function showToast(msg) {
      const t = document.getElementById('toast');
      t.textContent = msg;
      t.style.display = 'block';
      setTimeout(() => t.style.display = 'none', 3000);
    }
  </script>
</body>
</html>
