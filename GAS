/**
 * AppSheetからトリガーされ、レシート画像をGemini APIで解析し、
 * 結果をAppSheetに返すスクリプト
 * * * 推奨モデル: gemini-1.5-flash (高速・低コストで画像認識精度が高い)
 */

// --- 設定値のキー名（スクリプトプロパティ） ---
const PROP_API_KEY = 'GEMINI_API_KEY';
const PROP_FOLDER_ID = 'DRIVE_FOLDER_ID';
// ※書き込みはAppSheet側で行うため、SPREADSHEET_IDは不要になりました

// --- 使用するGeminiモデル ---
const GEMINI_MODEL = 'gemini-2.5-flash';

/**
 * AppSheetの "Call a script" から呼び出されるメイン関数
 * AppSheet側で "Function Name" にはこの関数名「analyzeReceipt」を選択してください。
 * * @param {string} imagePath - AppSheetから渡される画像ファイルパス（例: "A_給油実績_Images/領収書.png"）
 * @return {Object} 解析結果のオブジェクト（AppSheet側で各カラムにマッピングして使用）
 */
function analyzeReceipt(imagePath) {
  // 引数チェック
  if (!imagePath) {
    throw new Error('Image path is missing. Please check the function arguments in AppSheet.');
  }

  console.log(`Start analysis for: ${imagePath}`);

  try {
    // 1. スクリプトプロパティの取得
    const props = PropertiesService.getScriptProperties().getProperties();
    const apiKey = props[PROP_API_KEY];
    const driveFolderId = props[PROP_FOLDER_ID];

    if (!apiKey || !driveFolderId) {
      throw new Error('Script properties (GEMINI_API_KEY, DRIVE_FOLDER_ID) are not set correctly.');
    }

    // 2. 画像ファイルの取得とBase64エンコード
    // AppSheetの画像パスからファイル名のみ抽出
    const fileName = imagePath.split('/').pop();
    const imageBlob = getImageBlobFromDrive(driveFolderId, fileName);
    const base64Image = Utilities.base64Encode(imageBlob.getBytes());
    const mimeType = imageBlob.getContentType();

    // 3. Gemini APIによる画像解析
    const extractedData = analyzeImageWithGemini(apiKey, base64Image, mimeType);
    console.log('Raw Extracted Data:', JSON.stringify(extractedData));

    // 4. データの整形（AppSheetが受け取りやすい形式に変換）
    // 日付: "/" を "-" に置換（YYYY-MM-DD形式の方がエラーになりにくいため）
    let fuelDate = extractedData.date;
    if (fuelDate && typeof fuelDate === 'string') {
      fuelDate = fuelDate.replace(/\//g, '-'); 
    }

    // 企業名: 整形処理
    let companyName = extractedData.company_name;
    if (companyName && typeof companyName === 'string') {
      // (1) 空白(全角・半角)や改行が含まれている場合、それ以降を削除して「企業名のみ」にする
      // 例: "西日本フリート(株) ルート2早島..." -> "西日本フリート(株)"
      companyName = companyName.split(/[\s\u3000\n]+/)[0];

      // (2) (株) や （株） を 株式会社 に置換
      companyName = companyName.replace(/\(株\)/g, '株式会社').replace(/（株）/g, '株式会社');
    }

    // 金額・数量: カンマを除去して数値化（"1,200" -> 1200）
    const parseNumber = (val) => {
      if (!val) return null;
      if (typeof val === 'number') return val;
      // 文字列の場合、カンマを除去して数値変換
      const num = Number(val.toString().replace(/,/g, ''));
      return isNaN(num) ? null : num;
    };

    const finalData = {
      fuel_date: fuelDate,                        // 給油日 (YYYY-MM-DD)
      company_name: companyName,                  // 企業名 (整形済み)
      car_no: extractedData.car_number,           // 車両番号
      product: extractedData.product_name,        // 商品名
      quantity: parseNumber(extractedData.quantity), // 数量 (数値化)
      amount: parseNumber(extractedData.amount)      // 金額 (数値化)
    };

    console.log('Final Return Data:', JSON.stringify(finalData));

    // 5. 解析結果をAppSheetに返す
    return finalData;

  } catch (error) {
    console.error('Error:', error.toString());
    // エラー時もAppSheetにエラー情報を返すとデバッグしやすい
    throw new Error(`Script Error: ${error.toString()}`);
  }
}

/**
 * Google Driveから画像ファイルを取得する
 * ※フォルダ指定で見つからない場合、ドライブ全体から探すように強化
 * @param {string} folderId - 検索対象のフォルダID
 * @param {string} fileName - 検索するファイル名
 * @return {GoogleAppsScript.Base.Blob} 画像のBlobデータ
 */
function getImageBlobFromDrive(folderId, fileName) {
  // 1. 指定されたフォルダ内をまずは検索
  try {
    const folder = DriveApp.getFolderById(folderId);
    const files = folder.searchFiles(`title = '${fileName}' and trashed = false`);
    
    if (files.hasNext()) {
      return files.next().getBlob();
    }
  } catch (e) {
    console.warn(`Folder search failed or folderId is invalid: ${e.toString()}`);
  }

  // 2. 指定フォルダになかった場合、ドライブ全体から検索 (バックアップ策)
  // AppSheetがサブフォルダを作っている場合などに対応
  console.log(`File not found in specific folder. Searching entire Drive for: ${fileName}`);
  const globalFiles = DriveApp.searchFiles(`title = '${fileName}' and trashed = false`);
  
  if (globalFiles.hasNext()) {
    return globalFiles.next().getBlob();
  } else {
    // どこにもない場合
    throw new Error(`Image file not found anywhere in Drive: ${fileName}`);
  }
}

/**
 * Gemini APIを呼び出して画像を解析する
 * @param {string} apiKey - Gemini API Key
 * @param {string} base64Image - Base64エンコードされた画像データ
 * @param {string} mimeType - 画像のMIMEタイプ (image/png, image/jpeg etc.)
 * @return {Object} 解析結果のオブジェクト
 */
function analyzeImageWithGemini(apiKey, base64Image, mimeType) {
  const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${GEMINI_MODEL}:generateContent?key=${apiKey}`;

  // プロンプトの定義：JSON形式での出力を強制
  // 企業名の抽出指示を強化
  const promptText = `
    あなたはレシート読み取りのプロフェッショナルです。
    添付されたガソリンスタンドのレシート画像を解析し、以下の情報を抽出してJSON形式で出力してください。
    
    【抽出項目とJSONキー】
    - 日付 (date): YYYY/MM/DD形式。年が省略されている場合は現在に近い適切な年を補完してください。
    - 企業名 (company_name): レシートの発行元となる「法人名」または「企業名」のみを抽出してください。※重要: 店舗名（例：〇〇店、〇〇給油所）や支店名は含めないでください。
    - 車両番号 (car_number): レシートに記載されている車両番号（「車両No」「No」など）。※「ドアNo」等の管理番号ではなく、車両そのものの番号を優先してください。
    - 商品名 (product_name): "軽油"、"レギュラー"、"ハイオク" のいずれか。
    - 数量 (quantity): 給油量(L)。数値のみ抽出してください。※「85.00」のように小数点以下がゼロの場合は「85」と整数にしてください。
    - 金額 (amount): 合計金額(円)。数値のみ。※該当箇所が見当たらない場合は null または空文字にしてください。

    【出力ルール】
    - 余計なMarkdown記号（\`\`\`jsonなど）を含めず、純粋なJSONテキストのみを返してください。
    - 読み取れない項目は null にしてください。
  `;

  const payload = {
    contents: [{
      parts: [
        { text: promptText },
        {
          inline_data: {
            mime_type: mimeType,
            data: base64Image
          }
        }
      ]
    }],
    // レスポンスをJSONモードに設定
    generationConfig: {
      response_mime_type: "application/json"
    }
  };

  const options = {
    method: 'post',
    contentType: 'application/json',
    payload: JSON.stringify(payload),
    muteHttpExceptions: true
  };

  const response = UrlFetchApp.fetch(apiUrl, options);
  const responseCode = response.getResponseCode();
  const responseText = response.getContentText();

  if (responseCode !== 200) {
    throw new Error(`Gemini API Error (${responseCode}): ${responseText}`);
  }

  const responseJson = JSON.parse(responseText);
  
  // レスポンス構造からテキストを抽出
  try {
    const contentText = responseJson.candidates[0].content.parts[0].text;
    
    // より確実にJSON部分のみを抽出するロジック
    const startIndex = contentText.indexOf('{');
    const endIndex = contentText.lastIndexOf('}');
    
    if (startIndex === -1 || endIndex === -1) {
      throw new Error('JSON format not found in response');
    }
    
    const jsonString = contentText.substring(startIndex, endIndex + 1);
    return JSON.parse(jsonString);
  } catch (e) {
    console.error('Failed to parse Gemini response:', responseText);
    throw new Error('Gemini API response parsing failed.');
  }
}
